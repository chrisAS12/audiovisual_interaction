<!DOCTYPE html>
<html>
    <head>
        <title>Eksperiments</title>
        <script src="https://unpkg.com/jspsych@8.2.1"></script>
        <script
            src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@2.1.0"></script>
        <script
            src="https://unpkg.com/@jspsych/plugin-image-button-response@1.2.0"></script>
        <script src="https://unpkg.com/@jspsych/plugin-preload@2.1.0"></script>
        <script
            src="https://unpkg.com/@jspsych/plugin-call-function@2.1.0"></script>
        <script
            src="https://unpkg.com/@jspsych/plugin-survey-html-form@2.1.0"></script>
        <link href="https://unpkg.com/jspsych@8.2.1/css/jspsych.css"
            rel="stylesheet" type="text/css" />
        <link href="style.css" rel="stylesheet" type="text/css" />
    </head>
    <body></body>
    <script>
    const SEND_RESULTS = false; // vai sūtam uz datapipe serveri
    const FREQUENCIES = [100, 500, 1000, 5000, 9000];
    const SIZES = ['sss','ss','s','m','l','xl','xxl','xxxl','xxxxl'];
    const COLOURS = [
      'red-saturated', 'red-light', 'red-muted', 'red-dark',
      'orange-saturated', 'orange-light', 'orange-muted', 'orange-dark',
      'yellow-saturated', 'yellow-light', 'yellow-muted', 'yellow-dark',
      'chartreuse-saturated', 'chartreuse-light', 'chartreuse-muted', 'chartreuse-dark',
      'green-saturated', 'green-light', 'green-muted', 'green-dark',
      'cyan-saturated', 'cyan-light', 'cyan-muted', 'cyan-dark',
      'blue-saturated', 'blue-light', 'blue-muted', 'blue-dark',
      'purple-saturated', 'purple-light', 'purple-muted', 'purple-dark',
      'black', 'gray-dark', 'gray-medium', 'gray-light', 'white'
    ];
    const BOUBA_IMAGES = [
      'img/blob (1).svg','img/blob (2).svg','img/blob (3).svg',
      'img/blob (4).svg','img/blob (5).svg','img/blob (6).svg',
      'img/blob (7).svg','img/blob (8).svg','img/blob (9).svg',
      'img/blob (10).svg'
    ];
    const KIKI_IMAGES = [
      'img/Kiki.png','img/Kiki2.png','img/Kiki3.png',
      'img/Kiki4.png', 'img/Kiki5.png','img/Kiki6.png',
      'img/Kiki7.png','img/Kiki8.png','img/Kiki9.png',
      'img/Kiki10.png'
    ];
    const TEST_SIZE = 25; // Cik testus katram piemēram

    function playTone(frequency, duration = 500) {
      const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const oscillator = audioCtx.createOscillator();
      const gainNode = audioCtx.createGain();

      oscillator.type = 'sine';
      oscillator.frequency.value = frequency;

      oscillator.connect(gainNode);
      gainNode.connect(audioCtx.destination);

      oscillator.start();
      setTimeout(() => {
        oscillator.stop();
        audioCtx.close();
      }, duration);
    }

    const jsPsych = initJsPsych({
      on_finish: function() {
        const filteredData = jsPsych.data.get().filterCustom(trial => trial.test !== undefined);
        const filename = `test-${jsPsych.data.get().values()[0].participant_id || '-'}_${new Date().toISOString().replace(/[:.]/g, '-')}.csv`;
        console.log(filteredData.csv());

        const blob = new Blob([filteredData.csv()], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);

        if (SEND_RESULTS) {

          fetch('https://pipe.jspsych.org/api/data', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              experimentID: 'BDZLBcqP78dv',
              filename: filename,
              data: filteredData.csv()
            })
          }).then(response => {
            if (!response.ok) {
              console.error('Datu nosūtīšanas kļūda:', response.statusText);
            } else {
              console.log('Dati veiksmīgi nosūtīti uz serveri.');
            }
          });
        }
      }
    });
    
    var timeline = [];
    timeline.push({
      type: jsPsychSurveyHtmlForm,
      html: '<p>Lūdzu ievadiet savu ID:</p><input name="participantID" type="text">',
      on_finish: function(data){
        jsPsych.data.addProperties({participant_id: data.response.participantID});
      }
    });

    function generateBoubaKikiPairs(blobArr, kikiArr, n) {
      const all = [];
      for (let i = 0; i < blobArr.length; i++) {
        for (let j = 0; j < kikiArr.length; j++) {
          all.push([blobArr[i], kikiArr[j]]);
        }
      }
      return jsPsych.randomization.sampleWithoutReplacement(all, n);
    }

    function generateUniquePairs(arr, n) {
      const all = [];
      for (let i = 0; i < arr.length; i++) {
        for (let j = i + 1; j < arr.length; j++) {
          all.push([arr[i], arr[j]]);
        }
      }
      return jsPsych.randomization.sampleWithoutReplacement(all, n);
    }

    const colourPairs = generateUniquePairs(COLOURS, TEST_SIZE);
    const sizePairs = generateUniquePairs(SIZES, TEST_SIZE);
    const shapePairs = generateBoubaKikiPairs(BOUBA_IMAGES, KIKI_IMAGES, TEST_SIZE);

    const allTests = jsPsych.randomization.shuffle([
      ...colourPairs.map(p => ({ type: 'colour', items: p })),
      ...sizePairs.map(p => ({ type: 'size', items: p })),
      ...shapePairs.map(p => ({ type: 'shape', items: p }))
    ]);

    allTests.forEach((test, i) => {
      const frequency = FREQUENCIES[Math.floor(Math.random() * FREQUENCIES.length)];
      const [left, right] = jsPsych.randomization.shuffle(test.items);

      timeline.push({
        type: jsPsychImageButtonResponse,
        stimulus: '',
        choices: [left, right],
        button_html: [left, right].map(item => {
          if (test.type === 'colour') {
            return `<div class="colour-block colour-${item}"></div>`;
          } else if (test.type === 'size') {
            return `<div class="size-block size-${item}"></div>`;
          } else {
            return `<img src="${item}" class="shape-block">`;
            
          }
        }),
        trial_duration: 3000,
        post_trial_gap: 2000,
        on_start: function() {
          playTone(frequency);
        },
        data: {
          test: test.type,
          trial: i + 1,
          frequency: frequency,
          left_item: left,
          right_item: right
        },
        on_finish: function(data) {
          data.rt = Math.round(data.rt);
          data.clicked_item = data.response === 0 ? data.left_item : data.right_item;
          data.clicked_position = data.response === 0 ? 'left' : 'right';
          delete data.stimulus;
          delete data.response;
          delete data.trial_type;
          delete data.trial_index;
          delete data.plugin_version;
          delete data.time_elapsed;
        }
      });
    });

    timeline.push({
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '<p style="font-size:24px; color:white;">Paldies par dalību!</p>',
      choices: "NO_KEYS",
      trial_duration: 1000
    });

    jsPsych.run(timeline);

  </script>
</html>